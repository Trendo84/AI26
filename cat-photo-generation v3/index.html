<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>Cat.Zone AI Studio</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #FFF5E6 0%, #FFE8D6 100%);
            min-height: 100vh;
            padding: 20px;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: none;
            touch-action: pan-y;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 30px 20px;
            background: linear-gradient(135deg, #FFF8F5 0%, #FFEEE6 50%, #FFF8F5 100%);
            background-size: 200% 200%;
            border-radius: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            position: relative;
            overflow: hidden;
            animation: smooth-gradient 8s ease infinite;
        }

        @keyframes smooth-gradient {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(
                45deg,
                transparent 30%,
                rgba(255, 181, 167, 0.15) 50%,
                transparent 70%
            );
            animation: shimmer 6s ease-in-out infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%) translateY(-100%) rotate(0deg); }
            100% { transform: translateX(100%) translateY(100%) rotate(0deg); }
        }

        .header h1 {
            font-size: 32px;
            margin-bottom: 8px;
            font-weight: 700;
            position: relative;
            z-index: 1;
            color: #FFD700;
            -webkit-text-stroke: 2px #000000;
            text-stroke: 2px #000000;
            paint-order: stroke fill;
            filter: drop-shadow(0 2px 8px rgba(255, 215, 0, 0.4)) 
                    drop-shadow(0 4px 12px rgba(0, 0, 0, 0.3));
            animation: glow-pulse-yellow 3s ease-in-out infinite;
        }

        @keyframes glow-pulse-yellow {
            0%, 100% { 
                filter: drop-shadow(0 2px 8px rgba(255, 215, 0, 0.4)) 
                        drop-shadow(0 4px 12px rgba(0, 0, 0, 0.3));
            }
            50% { 
                filter: drop-shadow(0 3px 12px rgba(255, 215, 0, 0.6)) 
                        drop-shadow(0 4px 16px rgba(0, 0, 0, 0.4));
            }
        }

        .header p {
            color: #8B7355;
            font-size: 16px;
            position: relative;
            z-index: 1;
        }

        .mode-selector {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
            background: white;
            padding: 8px;
            border-radius: 16px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.06);
        }

        .mode-btn {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 12px;
            background: transparent;
            color: #8B7355;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .mode-btn.active {
            background: linear-gradient(135deg, #FFB5A7 0%, #FF9B85 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(255, 155, 133, 0.3);
        }

        .content-card {
            background: white;
            border-radius: 20px;
            padding: 24px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            margin-bottom: 20px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            color: #8B7355;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .input-group input[type="text"],
        .input-group textarea {
            width: 100%;
            padding: 14px;
            border: 2px solid #FFE8D6;
            border-radius: 12px;
            font-size: 16px;
            font-family: inherit;
            transition: border-color 0.3s ease;
        }

        .input-group input[type="text"]:focus,
        .input-group textarea:focus {
            outline: none;
            border-color: #FFB5A7;
        }

        .input-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .file-upload {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
            border: 3px dashed #FFB5A7;
            border-radius: 16px;
            background: #FFF5E6;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .file-upload:hover {
            background: #FFE8D6;
            border-color: #FF9B85;
        }

        .file-upload input {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .file-upload-icon {
            font-size: 48px;
            margin-bottom: 12px;
        }

        .file-upload-text {
            color: #8B7355;
            font-size: 16px;
            font-weight: 600;
        }

        .preview-container {
            margin-top: 16px;
            position: relative;
        }

        .preview-image {
            width: 100%;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .remove-preview {
            position: absolute;
            top: 12px;
            right: 12px;
            background: white;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .generate-btn {
            width: 100%;
            padding: 22px;
            background: linear-gradient(135deg, #FFB5A7 0%, #FF9B85 100%);
            color: white;
            border: none;
            border-radius: 18px;
            font-size: 20px;
            font-weight: 800;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 24px rgba(255, 155, 133, 0.5);
            -webkit-tap-highlight-color: transparent;
            margin-top: 32px;
            letter-spacing: 0.5px;
            text-transform: none;
            position: relative;
            overflow: hidden;
        }

        .generate-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            transition: left 0.5s;
        }

        .generate-btn.has-prompt {
            background: linear-gradient(270deg, #FF6B4A, #FF9B85, #FFB5A7, #FF9B85, #FF6B4A);
            background-size: 400% 400%;
            animation: gradient-flow 2s ease infinite, glow-pulse 2s ease-in-out infinite;
            box-shadow: 
                0 8px 32px rgba(255, 107, 74, 0.6),
                0 0 40px rgba(255, 155, 133, 0.8),
                0 0 60px rgba(255, 155, 133, 0.4),
                inset 0 0 20px rgba(255, 255, 255, 0.2);
        }

        @keyframes gradient-flow {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        @keyframes glow-pulse {
            0%, 100% { 
                box-shadow: 
                    0 8px 32px rgba(255, 107, 74, 0.6),
                    0 0 40px rgba(255, 155, 133, 0.8),
                    0 0 60px rgba(255, 155, 133, 0.4),
                    inset 0 0 20px rgba(255, 255, 255, 0.2);
            }
            50% { 
                box-shadow: 
                    0 8px 40px rgba(255, 107, 74, 0.9),
                    0 0 60px rgba(255, 155, 133, 1),
                    0 0 80px rgba(255, 155, 133, 0.6),
                    inset 0 0 30px rgba(255, 255, 255, 0.3);
            }
        }

        .generate-btn.has-prompt::before {
            animation: shine 1.5s ease-in-out infinite;
        }

        @keyframes shine {
            0% { left: -100%; }
            40%, 100% { left: 100%; }
        }

        .generate-btn:active:not(:disabled) {
            transform: scale(0.98);
        }

        .generate-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            animation: none;
        }

        .result-container {
            display: none;
            margin-top: 24px;
        }

        .result-container.show {
            display: block;
        }

        .result-image {
            width: 100%;
            border-radius: 16px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
            margin-bottom: 16px;
            position: relative;
        }

        .watermark-container {
            position: relative;
            display: inline-block;
            width: 100%;
        }

        .watermark {
            position: absolute;
            bottom: 16px;
            right: 16px;
            background: rgba(255, 255, 255, 0.95);
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 700;
            font-size: 14px;
            color: #FF9B85;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            pointer-events: none;
        }

        .premium-badge {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 700;
            margin-left: 6px;
            display: inline-block;
        }

        .result-actions {
            display: flex;
            gap: 12px;
        }

        .action-btn {
            flex: 1;
            padding: 14px;
            border: 2px solid #FFB5A7;
            background: white;
            color: #FF9B85;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .action-btn:hover {
            background: #FFB5A7;
            color: white;
        }

        .loading {
            text-align: center;
            padding: 40px;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #FFE8D6;
            border-top: 4px solid #FF9B85;
            border-radius: 50%;
            margin: 0 auto 16px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            color: #8B7355;
            font-size: 16px;
            font-weight: 600;
        }

        .error {
            background: #FFE8E8;
            border: 2px solid #FF6B6B;
            color: #C92A2A;
            padding: 16px;
            border-radius: 12px;
            margin-top: 16px;
            font-weight: 600;
        }

        .info-box {
            background: #E8F5FF;
            border: 2px solid #74C0FC;
            color: #1971C2;
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 20px;
            font-size: 14px;
            line-height: 1.5;
        }

        .api-setup {
            background: #FFF3CD;
            border: 2px solid #FFC107;
            color: #856404;
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 20px;
            font-size: 14px;
            line-height: 1.5;
        }

        .api-setup input {
            width: 100%;
            padding: 10px;
            margin-top: 8px;
            border: 2px solid #FFE8A1;
            border-radius: 8px;
            font-size: 14px;
            font-family: monospace;
        }

        .api-setup button {
            margin-top: 10px;
            padding: 10px 20px;
            background: #FFC107;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
        }

        .success-message {
            background: #D4EDDA;
            border: 2px solid #28A745;
            color: #155724;
            padding: 12px;
            border-radius: 8px;
            margin-top: 10px;
            font-weight: 600;
        }

        .preset-prompts {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .preset-btn {
            padding: 12px;
            background: white;
            border: 2px solid #FFE8D6;
            border-radius: 12px;
            color: #8B7355;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 600;
            -webkit-tap-highlight-color: transparent;
        }

        .preset-btn:active {
            background: #FFF5E6;
            border-color: #FFB5A7;
            transform: scale(0.97);
        }

        /* Tabbed interface - iOS style segmented control */
        .prompt-style-tabs {
            display: flex;
            gap: 0;
            margin-bottom: 20px;
            margin-top: 20px;
            background: #FFD4C8;
            padding: 4px;
            border-radius: 12px;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.08);
        }

        .tab-btn {
            flex: 1;
            padding: 10px 16px;
            border: none;
            background: transparent;
            color: #8B7355;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            border-radius: 9px;
            transition: all 0.3s ease;
            -webkit-tap-highlight-color: transparent;
        }

        .tab-btn.active {
            background: white;
            color: #FF9B85;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15), 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .tab-btn:active {
            transform: scale(0.97);
        }

        .tab-content {
            display: none;
            padding: 0;
            margin-top: 16px;
        }

        .tab-content.active {
            display: block;
        }

        .style-selector {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .style-option {
            padding: 12px;
            border: 2px solid #FFE8D6;
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            background: white;
            -webkit-tap-highlight-color: transparent;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .style-option:active {
            transform: scale(0.97);
        }

        .style-option.selected {
            background: linear-gradient(135deg, #FFB5A7 0%, #FF9B85 100%);
            color: white;
            border-color: #FF9B85;
            box-shadow: 0 2px 8px rgba(255, 155, 133, 0.3);
        }

        .style-emoji {
            font-size: 20px;
        }

        .style-name {
            font-size: 14px;
            font-weight: 600;
        }

        .premium-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .premium-modal.show {
            display: flex;
        }

        .premium-content {
            background: white;
            border-radius: 24px;
            padding: 32px;
            max-width: 400px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            text-align: center;
        }

        .premium-icon {
            font-size: 64px;
            margin-bottom: 16px;
        }

        .premium-title {
            font-size: 24px;
            font-weight: 700;
            color: #FF9B85;
            margin-bottom: 12px;
        }

        .premium-price {
            font-size: 48px;
            font-weight: 700;
            color: #8B7355;
            margin: 20px 0;
        }

        .premium-features {
            text-align: left;
            margin: 24px 0;
            padding: 0 20px;
        }

        .premium-feature {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
            font-size: 15px;
            color: #8B7355;
        }

        .premium-feature::before {
            content: "‚úì";
            color: #4CAF50;
            font-weight: 700;
            font-size: 20px;
            margin-right: 12px;
        }

        .premium-buttons {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        .premium-btn {
            flex: 1;
            padding: 16px;
            border: none;
            border-radius: 14px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .premium-btn.upgrade {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            color: white;
            box-shadow: 0 4px 16px rgba(255, 165, 0, 0.4);
        }

        .premium-btn.upgrade:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 165, 0, 0.5);
        }

        .premium-btn.cancel {
            background: #F5F5F5;
            color: #8B7355;
        }

        .usage-limit {
            background: #FFF3CD;
            border: 2px solid #FFC107;
            color: #856404;
            padding: 12px 16px;
            border-radius: 12px;
            margin-bottom: 20px;
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .usage-count {
            font-size: 18px;
            font-weight: 700;
            color: #FF9B85;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üê± CatZone AI Studio</h1>
            <p>Turn Any Idea Into Purr-fect Cat Magic ‚ú®</p>
        </div>

        <div class="mode-selector">
            <button class="mode-btn active" onclick="switchMode('generate')">
                ‚ú® Generate
            </button>
            <button class="mode-btn" onclick="switchMode('remix')">
                üé® Remix
            </button>
        </div>

        <div class="usage-limit" id="usageLimit">
            <span>Free generations: <span class="usage-count" id="usageCount">5/5</span></span>
            <button class="premium-btn upgrade" style="padding: 8px 16px; font-size: 13px;" onclick="showPremiumModal()">
                ‚≠ê Go Premium
            </button>
        </div>

        <div id="apiSetup" class="api-setup" style="display: none;">
            <strong>üîë API Setup Required</strong><br>
            Get your free API key from <a href="https://replicate.com" target="_blank" style="color: #856404; text-decoration: underline;">Replicate.com</a> (includes $5 free credits)<br>
            <input type="password" id="apiKeyInput" placeholder="r8_xxxxxxxxxxxxxxxxxxxxxxxxxxxxx">
            <button onclick="saveApiKey()">üíæ Save API Key</button>
            <div id="apiSuccess" style="display: none;" class="success-message">
                ‚úÖ API Key saved! You're ready to generate.
            </div>
        </div>

        <div class="info-box">
            <strong>üéâ Ready to Create!</strong><br>
            Generate unique cat photos from your imagination or remix your own photos into cat art. Share your creations with #CatZoneAI and tag @cat.z0ne! üê±
        </div>

        <!-- Generate Mode -->
        <div id="generateMode" class="content-card">
            <div class="input-group">
                <label>Describe your dream cat photo</label>
                <textarea id="generatePrompt" placeholder="Example: A fluffy orange tabby cat wearing a tiny crown, sitting on a throne"></textarea>
            </div>

            <!-- Tabbed Section for Prompts & Styles -->
            <div class="prompt-style-tabs">
                <button class="tab-btn active" onclick="switchTab('examples')">üìù Examples</button>
                <button class="tab-btn" onclick="switchTab('styles')">üé® Styles</button>
            </div>

            <!-- Examples Tab -->
            <div id="examplesTab" class="tab-content active">
                <div class="preset-prompts">
                    <button class="preset-btn" onclick="setPrompt('persian')">üéÄ Fluffy Persian</button>
                    <button class="preset-btn" onclick="setPrompt('kitten')">üß∂ Playful Kitten</button>
                    <button class="preset-btn" onclick="setPrompt('moonlight')">üåô Moonlight Cat</button>
                    <button class="preset-btn" onclick="setPrompt('cool')">üòé Cool Cat</button>
                    <button class="preset-btn" onclick="setPrompt('sleepy')">üí§ Sleepy Cat</button>
                    <button class="preset-btn" onclick="setPrompt('explorer')">üì¶ Box Explorer</button>
                    <button class="preset-btn" onclick="setPrompt('magic')">‚ú® Magic Cat</button>
                    <button class="preset-btn" onclick="setPrompt('royal')">üëë Royal Cat</button>
                </div>
            </div>

            <!-- Styles Tab -->
            <div id="stylesTab" class="tab-content">
                <div class="style-selector">
                    <div class="style-option selected" data-style="realistic" onclick="selectStyle(this)">
                        <div class="style-emoji">üì∏</div>
                        <div class="style-name">Realistic</div>
                    </div>
                    <div class="style-option" data-style="artistic" onclick="selectStyle(this)">
                        <div class="style-emoji">üé®</div>
                        <div class="style-name">Artistic</div>
                    </div>
                    <div class="style-option" data-style="cartoon" onclick="selectStyle(this)">
                        <div class="style-emoji">üé≠</div>
                        <div class="style-name">Cartoon</div>
                    </div>
                    <div class="style-option" data-style="dreamy" onclick="selectStyle(this)">
                        <div class="style-emoji">‚ú®</div>
                        <div class="style-name">Dreamy</div>
                    </div>
                    <div class="style-option" data-style="anime" onclick="selectStyle(this)">
                        <div class="style-emoji">üå∏</div>
                        <div class="style-name">Anime</div>
                    </div>
                    <div class="style-option" data-style="watercolor" onclick="selectStyle(this)">
                        <div class="style-emoji">üñåÔ∏è</div>
                        <div class="style-name">Watercolor</div>
                    </div>
                    <div class="style-option" data-style="vintage" onclick="selectStyle(this)">
                        <div class="style-emoji">üì∑</div>
                        <div class="style-name">Vintage</div>
                    </div>
                    <div class="style-option" data-style="cyberpunk" onclick="selectStyle(this)">
                        <div class="style-emoji">üåÜ</div>
                        <div class="style-name">Cyberpunk</div>
                    </div>
                </div>
            </div>

            <button class="generate-btn" onclick="generateImage()">
                ‚ú® Generate Cat Photo
            </button>
        </div>

        <!-- Remix Mode -->
        <div id="remixMode" class="content-card" style="display: none;">
            <div class="input-group">
                <label>Upload your photo</label>
                <div class="file-upload" id="fileUpload">
                    <input type="file" id="imageInput" accept="image/*" onchange="handleImageUpload(event)">
                    <div class="file-upload-icon">üì∏</div>
                    <div class="file-upload-text">Click to upload or drag & drop</div>
                </div>
                <div id="previewContainer" class="preview-container" style="display: none;">
                    <img id="previewImage" class="preview-image" alt="Preview">
                    <button class="remove-preview" onclick="removePreview()">‚úï</button>
                </div>
            </div>

            <div class="input-group">
                <label>Transform into...</label>
                <div class="style-selector">
                    <div class="style-option selected" data-remix="cat-face" onclick="selectRemix(this)">
                        <div class="style-emoji">üò∫</div>
                        <div class="style-name">Cat Face</div>
                    </div>
                    <div class="style-option" data-remix="cat-body" onclick="selectRemix(this)">
                        <div class="style-emoji">üê±</div>
                        <div class="style-name">Full Cat</div>
                    </div>
                    <div class="style-option" data-remix="cat-painting" onclick="selectRemix(this)">
                        <div class="style-emoji">üñºÔ∏è</div>
                        <div class="style-name">Cat Painting</div>
                    </div>
                    <div class="style-option" data-remix="cat-cartoon" onclick="selectRemix(this)">
                        <div class="style-emoji">üé®</div>
                        <div class="style-name">Cat Cartoon</div>
                    </div>
                    <div class="style-option" data-remix="cat-anime" onclick="selectRemix(this)">
                        <div class="style-emoji">üå∏</div>
                        <div class="style-name">Anime Cat</div>
                    </div>
                    <div class="style-option" data-remix="cat-pixel" onclick="selectRemix(this)">
                        <div class="style-emoji">üëæ</div>
                        <div class="style-name">Pixel Cat</div>
                    </div>
                    <div class="style-option" data-remix="cat-oil" onclick="selectRemix(this)">
                        <div class="style-emoji">üé≠</div>
                        <div class="style-name">Oil Painting</div>
                    </div>
                    <div class="style-option" data-remix="cat-sketch" onclick="selectRemix(this)">
                        <div class="style-emoji">‚úèÔ∏è</div>
                        <div class="style-name">Sketch</div>
                    </div>
                </div>
            </div>

            <button class="generate-btn" onclick="remixImage()" id="remixBtn" disabled>
                üé® Remix Photo
            </button>
        </div>

        <!-- Results -->
        <div id="resultContainer" class="content-card result-container">
            <img id="resultImage" class="result-image" alt="Generated result">
            <div class="result-actions">
                <button class="action-btn" onclick="downloadImage()">
                    üíæ Download
                </button>
                <button class="action-btn" onclick="shareImage()">
                    üì§ Share
                </button>
                <button class="action-btn" onclick="newGeneration()">
                    üîÑ New
                </button>
            </div>
        </div>
    </div>

    <!-- Premium Modal -->
    <div id="premiumModal" class="premium-modal">
        <div class="premium-content">
            <div class="premium-icon">‚≠ê</div>
            <div class="premium-title">Upgrade to Premium</div>
            <div style="color: #8B7355; margin-bottom: 8px;">Unlimited AI cat creations</div>
            <div class="premium-price">$1.99<span style="font-size: 18px; color: #8B7355;">/month</span></div>
            
            <div class="premium-features">
                <div class="premium-feature">Unlimited generations</div>
                <div class="premium-feature">No watermark on images</div>
                <div class="premium-feature">High-resolution downloads</div>
                <div class="premium-feature">Priority generation speed</div>
                <div class="premium-feature">Early access to new styles</div>
                <div class="premium-feature">Cancel anytime via customer portal</div>
            </div>

            <div class="premium-buttons">
                <button class="premium-btn cancel" onclick="closePremiumModal()">
                    Maybe Later
                </button>
                <button class="premium-btn upgrade" onclick="upgradeToPremium()">
                    Upgrade Now
                </button>
            </div>
        </div>
    </div>

    <!-- Define prompt library FIRST before any other scripts -->
    <script>
        // Prompt variations - MUST BE FIRST
        window.promptLibrary = {
            persian: [
                'A fluffy Persian cat with big eyes looking at camera',
                'A gorgeous white Persian cat with blue eyes in soft lighting',
                'An elegant gray Persian cat sitting on a velvet cushion',
                'A cream-colored Persian cat with a fluffy tail'
            ],
            kitten: [
                'A playful orange tabby kitten playing with yarn',
                'A tiny striped kitten chasing a butterfly',
                'An adorable ginger kitten with a ball of yarn',
                'A curious tabby kitten exploring a cardboard box'
            ],
            moonlight: [
                'A majestic black cat with green eyes in moonlight',
                'A mysterious dark cat silhouetted against the full moon',
                'A sleek black cat sitting on a windowsill at night',
                'An elegant black cat with glowing eyes under moonbeams'
            ],
            cool: [
                'A cute Siamese cat wearing sunglasses',
                'A stylish cat with aviator sunglasses and a leather jacket',
                'A hip cat wearing round sunglasses at the beach',
                'A cool tabby cat with sunglasses in front of a sunset'
            ],
            sleepy: [
                'A fluffy white cat sleeping on a cozy blanket',
                'A peaceful orange cat napping in a sunny spot',
                'A content cat curled up on a soft pillow',
                'A drowsy kitten yawning on a warm bed'
            ],
            explorer: [
                'A curious ginger cat peeking through a cardboard box',
                'An adventurous cat climbing out of a shipping box',
                'A playful cat hiding inside a brown cardboard box',
                'A sneaky tabby cat popping out of a box fort'
            ],
            magic: [
                'A mystical cat with glowing magical aura and sparkles',
                'An enchanted white cat surrounded by floating stars',
                'A wizard cat with a pointed hat casting a spell',
                'A magical calico cat with constellation patterns in fur'
            ],
            royal: [
                'A regal cat wearing a golden crown on a throne',
                'An elegant Siamese cat dressed in royal velvet robes',
                'A majestic Persian cat with a jeweled collar in palace',
                'A noble tabby cat sitting on an ornate royal cushion'
            ]
        };
    </script>

    <!-- Stripe JS -->
    <script src="https://js.stripe.com/v3/"></script>

    <script>
        // Initialize Stripe - wait for it to load
        let stripe;
        if (typeof Stripe !== 'undefined') {
            stripe = Stripe('pk_live_51SpkTlJmwiNn9GMmWgo5zqllZhek0HLVt0CGu7LJeYdwajox8SmLcAqSHBStGONgoItzXjc42KLR9VM6mIbmZG5300rMIwWgcb');
        }
        
        let currentMode = 'generate';
        let selectedStyle = 'realistic';
        let selectedRemix = 'cat-face';
        let uploadedImage = null;
        let generatedImageUrl = null;
        let apiKey = 'r8_HVxMnIWj5vSjFFMX13TdG8DeUX4SgG64Z9qbx';
        
        // Premium and usage tracking with fingerprinting
        let isPremium = localStorage.getItem('isPremium') === 'true';
        let deviceFingerprint = null;
        const FREE_LIMIT = 5; // Changed to 5 free generations

        // Generate browser fingerprint
        async function generateFingerprint() {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            ctx.textBaseline = 'top';
            ctx.font = '14px Arial';
            ctx.textBaseline = 'alphabetic';
            ctx.fillStyle = '#f60';
            ctx.fillRect(125, 1, 62, 20);
            ctx.fillStyle = '#069';
            ctx.fillText('Browser Fingerprint', 2, 15);
            ctx.fillStyle = 'rgba(102, 204, 0, 0.7)';
            ctx.fillText('Browser Fingerprint', 4, 17);
            
            const fingerprint = canvas.toDataURL();
            
            // Combine with other browser data
            const data = {
                canvas: fingerprint,
                userAgent: navigator.userAgent,
                language: navigator.language,
                timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                screen: `${screen.width}x${screen.height}x${screen.colorDepth}`,
                platform: navigator.platform
            };
            
            // Create hash
            const str = JSON.stringify(data);
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            
            return 'fp_' + Math.abs(hash).toString(36);
        }

        // Get usage count for this device
        function getUsageCount() {
            if (isPremium) return 0;
            
            const usageData = JSON.parse(localStorage.getItem('usageData') || '{}');
            return usageData[deviceFingerprint] || 0;
        }

        // Increment usage count
        function incrementUsageFingerprint() {
            if (isPremium) return;
            
            const usageData = JSON.parse(localStorage.getItem('usageData') || '{}');
            usageData[deviceFingerprint] = (usageData[deviceFingerprint] || 0) + 1;
            localStorage.setItem('usageData', JSON.stringify(usageData));
            updateUsageDisplay();
        }

        // Hide API setup since key is integrated
        window.addEventListener('DOMContentLoaded', async () => {
            document.getElementById('apiSetup').style.display = 'none';
            
            // Generate fingerprint
            deviceFingerprint = await generateFingerprint();
            console.log('Device fingerprint:', deviceFingerprint);
            
            updateUsageDisplay();
            
            if (isPremium) {
                document.getElementById('usageLimit').style.display = 'none';
            }
        });

        function updateUsageDisplay() {
            const usageCount = getUsageCount();
            const remaining = Math.max(0, FREE_LIMIT - usageCount);
            document.getElementById('usageCount').textContent = `${remaining}/${FREE_LIMIT}`;
            
            if (remaining === 0 && !isPremium) {
                document.getElementById('usageCount').parentElement.innerHTML = 
                    '<span style="color: #DC3545;">Out of free generations! ‚ö†Ô∏è</span>';
            }
        }

        function checkUsageLimit() {
            if (isPremium) return true;
            
            const usageCount = getUsageCount();
            if (usageCount >= FREE_LIMIT) {
                showPremiumModal();
                return false;
            }
            return true;
        }

        function incrementUsage() {
            incrementUsageFingerprint();
        }

        function showPremiumModal() {
            document.getElementById('premiumModal').classList.add('show');
        }

        function closePremiumModal() {
            document.getElementById('premiumModal').classList.remove('show');
        }

        async function upgradeToPremium() {
            // Show loading state
            const upgradeBtn = document.querySelector('.premium-btn.upgrade');
            const originalText = upgradeBtn.textContent;
            upgradeBtn.textContent = 'Processing...';
            upgradeBtn.disabled = true;

            try {
                // Call Netlify function to create Stripe checkout session
                const response = await fetch('/.netlify/functions/create-checkout-session', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        priceId: 'price_1SpkwbJmwiNn9GMmNUwxLJcB',
                        deviceFingerprint: deviceFingerprint
                    })
                });

                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }

                const session = await response.json();

                // Redirect to Stripe Checkout
                const result = await stripe.redirectToCheckout({
                    sessionId: session.id
                });

                if (result.error) {
                    alert(result.error.message);
                    upgradeBtn.textContent = originalText;
                    upgradeBtn.disabled = false;
                }
            } catch (error) {
                console.error('Payment error:', error);
                alert('Unable to process payment. Please try again later.');
                upgradeBtn.textContent = originalText;
                upgradeBtn.disabled = false;
            }
        }

        function saveApiKey() {
            const key = document.getElementById('apiKeyInput').value.trim();
            if (!key) {
                alert('Please enter your API key');
                return;
            }
            if (!key.startsWith('r8_')) {
                alert('Invalid API key format. Replicate keys start with "r8_"');
                return;
            }
            localStorage.setItem('replicate_api_key', key);
            apiKey = key;
            document.getElementById('apiSuccess').style.display = 'block';
        }

        function switchMode(mode) {
            currentMode = mode;
            
            // Update button states
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Show/hide content
            if (mode === 'generate') {
                document.getElementById('generateMode').style.display = 'block';
                document.getElementById('remixMode').style.display = 'none';
            } else {
                document.getElementById('generateMode').style.display = 'none';
                document.getElementById('remixMode').style.display = 'block';
            }
            
            // Hide results
            document.getElementById('resultContainer').classList.remove('show');
        }

        function switchTab(tab) {
            // Update button states
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Show/hide tab content
            document.getElementById('examplesTab').classList.remove('active');
            document.getElementById('stylesTab').classList.remove('active');
            
            if (tab === 'examples') {
                document.getElementById('examplesTab').classList.add('active');
            } else if (tab === 'styles') {
                document.getElementById('stylesTab').classList.add('active');
            }
        }

        function setPrompt(category) {
            const prompts = window.promptLibrary[category];
            const randomPrompt = prompts[Math.floor(Math.random() * prompts.length)];
            document.getElementById('generatePrompt').value = randomPrompt;
        }

        function selectStyle(element) {
            document.querySelectorAll('#generateMode .style-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            element.classList.add('selected');
            selectedStyle = element.getAttribute('data-style');
        }

        function selectRemix(element) {
            document.querySelectorAll('#remixMode .style-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            element.classList.add('selected');
            selectedRemix = element.getAttribute('data-remix');
        }

        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    uploadedImage = e.target.result;
                    document.getElementById('previewImage').src = e.target.result;
                    document.getElementById('previewContainer').style.display = 'block';
                    document.getElementById('remixBtn').disabled = false;
                };
                reader.readAsDataURL(file);
            }
        }

        function removePreview() {
            uploadedImage = null;
            document.getElementById('previewContainer').style.display = 'none';
            document.getElementById('imageInput').value = '';
            document.getElementById('remixBtn').disabled = true;
        }

        function buildPrompt(basePrompt, style) {
            const styleModifiers = {
                'realistic': 'professional photography, highly detailed, 8k resolution',
                'artistic': 'oil painting style, artistic, impressionist',
                'cartoon': 'cartoon illustration, cute, animated style, pixar style',
                'dreamy': 'dreamy atmosphere, soft lighting, ethereal, magical'
            };
            
            return `${basePrompt}, ${styleModifiers[style]}, high quality`;
        }

        function buildRemixPrompt(remixType) {
            const remixModifiers = {
                'cat-face': 'transform this into a cat face, keeping the pose and composition, realistic cat features, adorable and expressive',
                'cat-body': 'transform this person into a full cat body, anthropomorphic cat, keeping the personality and pose',
                'cat-painting': 'artistic oil painting of this as a cat, classical painting style, museum quality, rich colors',
                'cat-cartoon': 'cute cartoon cat version of this, pixar animation style, expressive, colorful',
                'cat-anime': 'anime style cat character based on this, kawaii aesthetic, manga art style, big expressive eyes',
                'cat-pixel': 'pixel art cat version of this, 8-bit retro game style, colorful pixels, nostalgic gaming aesthetic',
                'cat-oil': 'oil painting of this as a cat, impressionist style, thick brush strokes, artistic texture',
                'cat-sketch': 'pencil sketch drawing of this as a cat, hand-drawn style, artistic lines, sketchy aesthetic'
            };
            
            const prompt = remixModifiers[remixType] || remixModifiers['cat-face'];
            
            // Validation check
            if (!prompt) {
                throw new Error('Invalid remix type selected');
            }
            
            return prompt;
        }

        async function generateImage() {
            if (!checkUsageLimit()) return;
            
            const prompt = document.getElementById('generatePrompt').value.trim();
            
            if (!prompt) {
                alert('Please describe the cat photo you want to generate!');
                return;
            }

            const fullPrompt = buildPrompt(prompt, selectedStyle);
            showLoading('Generating your cat photo with AI...');

            try {
                // Call our Netlify function (proxies to Replicate)
                const response = await fetch('/.netlify/functions/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        prompt: fullPrompt,
                        style: selectedStyle
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    let errorMessage = 'Failed to start generation';
                    try {
                        const errorData = JSON.parse(errorText);
                        errorMessage = errorData.detail || errorData.error || errorMessage;
                    } catch (e) {
                        errorMessage = errorText || errorMessage;
                    }
                    throw new Error(errorMessage);
                }

                const prediction = await response.json();
                
                // Poll for result
                await pollPrediction(prediction.id);
                
            } catch (error) {
                console.error('Generation error:', error);
                if (error.message.includes('Failed to fetch') || error.message.includes('Load failed')) {
                    showError('Network error. Please check your connection and try again.');
                } else {
                    showError(`Failed to generate: ${error.message}`);
                }
            }
        }

        async function remixImage() {
            if (!checkUsageLimit()) return;
            
            if (!uploadedImage) {
                showError('Please upload an image first!');
                return;
            }

            const remixPrompt = buildRemixPrompt(selectedRemix);
            
            if (!remixPrompt) {
                showError('Please select a remix style!');
                return;
            }
            
            showLoading('Remixing your photo with AI magic...');

            try {
                // Call our Netlify function (proxies to Replicate)
                const response = await fetch('/.netlify/functions/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        prompt: remixPrompt,
                        style: selectedRemix
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    let errorMessage = 'Failed to start remix';
                    try {
                        const errorData = JSON.parse(errorText);
                        errorMessage = errorData.detail || errorData.error || errorMessage;
                    } catch (e) {
                        errorMessage = errorText || errorMessage;
                    }
                    throw new Error(errorMessage);
                }

                const prediction = await response.json();
                await pollPrediction(prediction.id);
                
            } catch (error) {
                console.error('Remix error:', error);
                if (error.message.includes('Failed to fetch') || error.message.includes('Load failed')) {
                    showError('Network error. Please check your connection and try again.');
                } else {
                    showError(`Failed to remix image: ${error.message}`);
                }
            }
        }

        async function pollPrediction(predictionId) {
            const maxAttempts = 60; // 2 minutes max
            let attempts = 0;

            while (attempts < maxAttempts) {
                await new Promise(resolve => setTimeout(resolve, 2000)); // Check every 2 seconds
                
                try {
                    // Call our Netlify function to check status
                    const response = await fetch(`/.netlify/functions/check-prediction?id=${predictionId}`);

                    if (!response.ok) {
                        throw new Error(`Poll failed: ${response.status}`);
                    }

                    const prediction = await response.json();

                    if (prediction.status === 'succeeded') {
                        if (prediction.output && prediction.output.length > 0) {
                            showResult(prediction.output[0]);
                        } else {
                            throw new Error('No output received from API');
                        }
                        return;
                    } else if (prediction.status === 'failed') {
                        throw new Error(`Generation failed: ${prediction.error || 'Unknown error'}`);
                    } else if (prediction.status === 'canceled') {
                        throw new Error('Generation was canceled');
                    }

                    // Still processing
                    attempts++;
                } catch (error) {
                    console.error('Error during polling:', error);
                    throw error;
                }
            }

            throw new Error('Generation timed out after 2 minutes');
        }

        function showLoading(message) {
            const container = document.getElementById('resultContainer');
            container.innerHTML = `
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <div class="loading-text">${message}</div>
                    <div style="color: #8B7355; font-size: 14px; margin-top: 12px;">This may take 15-30 seconds...</div>
                </div>
            `;
            container.classList.add('show');
        }

        function showError(message) {
            const container = document.getElementById('resultContainer');
            container.innerHTML = `
                <div class="error">${message}</div>
            `;
            container.classList.add('show');
        }

        function showResult(imageUrl) {
            generatedImageUrl = imageUrl;
            incrementUsage();
            
            const container = document.getElementById('resultContainer');
            
            const watermarkHTML = isPremium ? '' : '<div class="watermark">@cat.z0ne</div>';
            
            container.innerHTML = `
                <div class="watermark-container">
                    <img id="resultImage" class="result-image" src="${imageUrl}" alt="Generated result" crossorigin="anonymous">
                    ${watermarkHTML}
                </div>
                <div class="result-actions">
                    <button class="action-btn" onclick="downloadImage()">
                        üíæ Download
                    </button>
                    <button class="action-btn" onclick="shareImage()">
                        üì§ Share
                    </button>
                    <button class="action-btn" onclick="newGeneration()">
                        üîÑ New
                    </button>
                </div>
                ${!isPremium ? '<div style="text-align: center; margin-top: 12px; color: #8B7355; font-size: 14px;">Want no watermark? <a href="#" onclick="showPremiumModal(); return false;" style="color: #FF9B85; font-weight: 600;">Go Premium ‚≠ê</a></div>' : ''}
            `;
            container.classList.add('show');
        }

        async function downloadImage() {
            if (!generatedImageUrl) return;
            
            try {
                // Create canvas to add watermark
                const img = new Image();
                img.crossOrigin = 'anonymous';
                
                await new Promise((resolve, reject) => {
                    img.onload = resolve;
                    img.onerror = reject;
                    img.src = generatedImageUrl;
                });
                
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = img.width;
                canvas.height = img.height;
                
                // Draw image
                ctx.drawImage(img, 0, 0);
                
                // Add watermark if not premium
                if (!isPremium) {
                    const watermarkText = '@cat.z0ne';
                    const fontSize = Math.max(canvas.width * 0.04, 20);
                    ctx.font = `bold ${fontSize}px Arial`;
                    
                    // Measure text
                    const textMetrics = ctx.measureText(watermarkText);
                    const textWidth = textMetrics.width;
                    const textHeight = fontSize;
                    
                    // Position in bottom right
                    const x = canvas.width - textWidth - 20;
                    const y = canvas.height - 20;
                    
                    // Semi-transparent background
                    ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
                    ctx.fillRect(x - 10, y - textHeight, textWidth + 20, textHeight + 10);
                    
                    // White text
                    ctx.fillStyle = 'white';
                    ctx.fillText(watermarkText, x, y);
                }
                
                // Convert to blob and download
                canvas.toBlob((blob) => {
                    const url = window.URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `catzone-ai-${Date.now()}.jpg`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    window.URL.revokeObjectURL(url);
                }, 'image/jpeg', 0.95);
                
            } catch (error) {
                console.error('Download error:', error);
                alert('Download failed. Please try again or right-click the image and save it manually.');
            }
        }

        async function shareImage() {
            if (!generatedImageUrl) return;

            try {
                // Try to share the actual image if on mobile
                if (navigator.share && navigator.canShare) {
                    // Fetch the image as blob
                    const response = await fetch(generatedImageUrl);
                    const blob = await response.blob();
                    const file = new File([blob], 'catzone-ai.jpg', { type: 'image/jpeg' });
                    
                    // Check if we can share files
                    if (navigator.canShare({ files: [file] })) {
                        await navigator.share({
                            title: 'My AI Cat Photo üê±',
                            text: 'Made with Cat.Zone AI Studio ‚ú®\n\nCreate your own at catzone.app',
                            files: [file]
                        });
                        return;
                    }
                }
                
                // Fallback: Copy image URL or app link
                copyImageLink();
                
            } catch (err) {
                console.error('Share error:', err);
                copyImageLink();
            }
        }

        function copyImageLink() {
            const shareText = `Check out my AI cat photo! üê±‚ú®\n\nMade with Cat.Zone AI Studio\nCreate yours: https://catzone.app\n\n#CatZoneAI #AIArt`;
            
            const dummy = document.createElement('textarea');
            document.body.appendChild(dummy);
            dummy.value = shareText;
            dummy.select();
            document.execCommand('copy');
            document.body.removeChild(dummy);
            alert('Share message copied! üìã\n\nPaste it with your cat photo on Instagram! üê±');
        }

        function newGeneration() {
            document.getElementById('resultContainer').classList.remove('show');
            if (currentMode === 'remix') {
                removePreview();
            }
        }

        // Add gradient animation to generate button when prompt is filled
        const generatePromptInput = document.getElementById('generatePrompt');
        const generateButtons = document.querySelectorAll('.generate-btn');
        
        generatePromptInput.addEventListener('input', function() {
            generateButtons.forEach(btn => {
                if (this.value.trim().length > 0) {
                    btn.classList.add('has-prompt');
                } else {
                    btn.classList.remove('has-prompt');
                }
            });
        });

        // Drag and drop support
        const fileUpload = document.getElementById('fileUpload');
        
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            fileUpload.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            fileUpload.addEventListener(eventName, highlight, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            fileUpload.addEventListener(eventName, unhighlight, false);
        });

        function highlight(e) {
            fileUpload.style.borderColor = '#FF9B85';
            fileUpload.style.background = '#FFE8D6';
        }

        function unhighlight(e) {
            fileUpload.style.borderColor = '#FFB5A7';
            fileUpload.style.background = '#FFF5E6';
        }

        fileUpload.addEventListener('drop', handleDrop, false);

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            
            if (files.length > 0) {
                document.getElementById('imageInput').files = files;
                handleImageUpload({ target: { files: files } });
            }
        }
    </script>
</body>
</html>
